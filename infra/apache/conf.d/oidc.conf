# mod_auth_openidc configuration for protecting /partner/*
OIDCProviderMetadataURL https://keycloak.local/realms/portal-dev/.well-known/openid-configuration
OIDCClientID partner-proxy
OIDCClientSecret ${OIDC_PARTNER_PROXY_SECRET}
OIDCRedirectURI https://portal.local/oidc_popup_callback.html
OIDCCryptoPassphrase ${OIDC_CRYPTO_PASSPHRASE}
OIDCScope "openid profile email roles"
OIDCResponseType code
OIDCRemoteUserClaim preferred_username
OIDCSessionType server-cache
OIDCSessionInactivityTimeout 900
OIDCSessionMaxDuration 28800
OIDCPassClaimsAs environment
OIDCPassIDTokenAs serialized
OIDCPassRefreshToken On
OIDCProviderTokenEndpointAuth client_secret_post
OIDCProviderCAFile /etc/apache2/tls/portal-dev-ca.crt

# Allow Apache to forward enriched identity headers to the partner app
RequestHeader set X-User-Name "%{OIDC_CLAIM_preferred_username}e" env=OIDC_CLAIM_preferred_username
RequestHeader set X-User-Email "%{OIDC_CLAIM_email}e" env=OIDC_CLAIM_email
RequestHeader set X-User-Roles "%{OIDC_CLAIM_realm_access.roles}e" env=OIDC_CLAIM_realm_access_roles

ProxyPass /partner/ http://partner:8080/ retry=0 timeout=90 Keepalive=On
ProxyPassReverse /partner/ http://partner:8080/

<Location "/partner">
  AuthType openid-connect
  Require claim realm_access.roles:partner-user
  Require valid-user
  Header set Content-Security-Policy "frame-ancestors 'self';"
</Location>

# Callback endpoint served as a static asset (mounted via DocumentRoot)
Alias /oidc_popup_callback.html /var/www/html/oidc_popup_callback.html
<Files "/var/www/html/oidc_popup_callback.html">
  Require all granted
  Header always set Cache-Control "no-store"
</Files>
